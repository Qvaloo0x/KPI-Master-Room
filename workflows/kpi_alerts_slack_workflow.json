{"name": "KPI Alerts to Slack with Dashboard Link", "nodes": [{"parameters": {"cronExpression": "0 */3 * * *"}, "name": "Trigger every 3h", "type": "n8n-nodes-base.cron", "typeVersion": 1, "position": [100, 300]}, {"parameters": {"authentication": "oAuth2", "sheetId": "1x_fake_sheet_id_x", "range": "SSOT!A1:Z1000"}, "name": "Read SSOT Sheet", "type": "n8n-nodes-base.googleSheets", "typeVersion": 1, "position": [300, 300]}, {"parameters": {"functionCode": "\nconst items = $input.all();\nconst today = new Date().toISOString().slice(0, 10);\nconst records = items.filter(i => i.json.Date <= today);\n\nconst getAvg = (arr, key) =>\n  arr.length ? arr.reduce((sum, r) => sum + parseFloat(r.json[key] || 0), 0) / arr.length : 0;\n\nconst todayData = records.filter(r => r.json.Date === today);\nconst past7Days = records.filter(r => {\n  const d = new Date(r.json.Date);\n  const ref = new Date();\n  ref.setDate(ref.getDate() - 7);\n  return d >= ref && d < new Date(today);\n});\n\nconst alerts = [];\n\ntodayData.forEach((row) => {\n  const campaign = row.json.Campaign_ID || 'Unknown';\n  const cacToday = parseFloat(row.json.CAC || 0);\n  const roasToday = parseFloat(row.json.ROAS || 0);\n  const cacAvg = getAvg(past7Days, 'CAC');\n  const roasAvg = getAvg(past7Days, 'ROAS');\n\n  if (cacAvg && cacToday > cacAvg * 1.25) {\n    alerts.push({\n      json: {\n        type: \"High CAC\",\n        campaign,\n        value: cacToday.toFixed(2),\n        average: cacAvg.toFixed(2),\n        diff: `${(((cacToday / cacAvg) - 1) * 100).toFixed(1)}%`,\n        link: `https://lookerstudio.google.com/reporting/your-dashboard-id/page/xyz?campaign=${encodeURIComponent(campaign)}`\n      }\n    });\n  }\n\n  if (roasAvg && roasToday < roasAvg * 0.75) {\n    alerts.push({\n      json: {\n        type: \"Low ROAS\",\n        campaign,\n        value: roasToday.toFixed(2),\n        average: roasAvg.toFixed(2),\n        diff: `${(((roasToday / roasAvg) - 1) * 100).toFixed(1)}%`,\n        link: `https://lookerstudio.google.com/reporting/your-dashboard-id/page/xyz?campaign=${encodeURIComponent(campaign)}`\n      }\n    });\n  }\n});\n\nreturn alerts;\n"}, "name": "Detect Anomalies", "type": "n8n-nodes-base.function", "typeVersion": 1, "position": [500, 300]}, {"parameters": {"resource": "message", "operation": "post", "channel": "#marketing-alerts", "jsonParameters": true, "message": "={{ `*\ud83d\udea8 KPI Alert: ${$json.type}*\n*Campaign:* ${$json.campaign}\n*Current Value:* ${$json.value}\n*7-day Avg:* ${$json.average}\n*Deviation:* ${$json.diff}` }}", "attachments": "[{ \"text\": \"\ud83d\udd17 View in Dashboard\", \"actions\": [{ \"type\": \"button\", \"text\": \"Open Campaign Report\", \"url\": \"{{$json.link}}\" }] }]"}, "name": "Send to Slack", "type": "n8n-nodes-base.slack", "typeVersion": 1, "position": [700, 300]}], "connections": {"Trigger every 3h": {"main": [["Read SSOT Sheet"]]}, "Read SSOT Sheet": {"main": [["Detect Anomalies"]]}, "Detect Anomalies": {"main": [["Send to Slack"]]}}}