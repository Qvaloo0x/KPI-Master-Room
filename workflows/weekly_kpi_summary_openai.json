{"name": "Weekly KPI Summary with OpenAI", "nodes": [{"parameters": {"cronExpression": "0 8 * * 1"}, "name": "Weekly Trigger", "type": "n8n-nodes-base.cron", "typeVersion": 1, "position": [100, 300]}, {"parameters": {"authentication": "oAuth2", "sheetId": "1x_fake_sheet_id_x", "range": "SSOT!A1:Z1000"}, "name": "Read SSOT Sheet", "type": "n8n-nodes-base.googleSheets", "typeVersion": 1, "position": [300, 300]}, {"parameters": {"functionCode": "\nconst data = items.map(item => item.json);\nconst parseDate = (str) => new Date(str);\nconst now = new Date();\nconst lastWeek = new Date(now);\nlastWeek.setDate(now.getDate() - 7);\nconst prevWeek = new Date(now);\nprevWeek.setDate(now.getDate() - 14);\n\nconst thisWeek = data.filter(r => parseDate(r.Date) >= lastWeek);\nconst lastWeekData = data.filter(r => parseDate(r.Date) >= prevWeek && parseDate(r.Date) < lastWeek);\n\nconst avg = (arr, key) => arr.length ? arr.reduce((sum, r) => sum + parseFloat(r[key] || 0), 0) / arr.length : 0;\n\nreturn [{\n  json: {\n    Start_Date: lastWeek.toISOString().split('T')[0],\n    End_Date: now.toISOString().split('T')[0],\n    Avg_CAC_This_Week: avg(thisWeek, 'CAC'),\n    Avg_CAC_Last_Week: avg(lastWeekData, 'CAC'),\n    Avg_ROAS_This_Week: avg(thisWeek, 'ROAS'),\n    Avg_ROAS_Last_Week: avg(lastWeekData, 'ROAS'),\n    Timestamp: new Date().toISOString(),\n    Workflow_ID: \"weekly-summary-v1\"\n  }\n}];\n"}, "name": "Calculate Weekly Averages", "type": "n8n-nodes-base.function", "typeVersion": 1, "position": [500, 300]}, {"parameters": {"authentication": "predefinedCredentialType", "httpMethod": "POST", "url": "https://api.openai.com/v1/chat/completions", "jsonParameters": true, "options": {}, "bodyParametersJson": "\n{\n  \"model\": \"gpt-4\",\n  \"messages\": [\n    {\n      \"role\": \"system\",\n      \"content\": \"Eres un asistente que redacta res\u00famenes ejecutivos de KPIs de marketing para un CMO.\"\n    },\n    {\n      \"role\": \"user\",\n      \"content\": \"Analiza los datos semanales:\nCAC esta semana: {{$json.Avg_CAC_This_Week}}\nCAC semana pasada: {{$json.Avg_CAC_Last_Week}}\nROAS esta semana: {{$json.Avg_ROAS_This_Week}}\nROAS semana pasada: {{$json.Avg_ROAS_Last_Week}}\n\nRedacta un resumen de 3 l\u00edneas, claro y profesional.\"\n    }\n  ]\n}\n"}, "name": "OpenAI Summary", "type": "n8n-nodes-base.httpRequest", "typeVersion": 1, "position": [700, 300]}, {"parameters": {"values": {"string": [{"name": "LLM_Summary", "value": "={{ $json.choices[0].message.content }}"}]}}, "name": "Format Summary", "type": "n8n-nodes-base.set", "typeVersion": 1, "position": [900, 300]}, {"parameters": {"authentication": "oAuth2", "sheetId": "1x_fake_sheet_id_x", "range": "Summary!A1", "valueInputMode": "USER_ENTERED"}, "name": "Save Summary to Sheet", "type": "n8n-nodes-base.googleSheets", "typeVersion": 1, "position": [1100, 300]}, {"parameters": {"fromEmail": "cmoreports@yourdomain.com", "toEmail": "cmo@yourdomain.com", "subject": "Resumen Ejecutivo Semanal - KPIs de Marketing", "text": "Resumen generado:\n\n{{ $json.LLM_Summary }}\n\nLink a Dashboard: https://lookerstudio.google.com/reporting/tu-dashboard-id"}, "name": "Email to CMO", "type": "n8n-nodes-base.emailSend", "typeVersion": 1, "position": [1300, 300]}], "connections": {"Weekly Trigger": {"main": [["Read SSOT Sheet"]]}, "Read SSOT Sheet": {"main": [["Calculate Weekly Averages"]]}, "Calculate Weekly Averages": {"main": [["OpenAI Summary"]]}, "OpenAI Summary": {"main": [["Format Summary"]]}, "Format Summary": {"main": [["Save Summary to Sheet", "Email to CMO"]]}}}