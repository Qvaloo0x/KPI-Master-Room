{"name": "KPI Anomaly Alerts", "nodes": [{"parameters": {"cronExpression": "0 */3 * * *"}, "name": "Trigger cada 3h", "type": "n8n-nodes-base.cron", "typeVersion": 1, "position": [100, 300]}, {"parameters": {"authentication": "oAuth2", "sheetId": "1x_fake_sheet_id_x", "range": "SSOT!A1:Z1000"}, "name": "Read SSOT", "type": "n8n-nodes-base.googleSheets", "typeVersion": 1, "position": [300, 300]}, {"parameters": {"functionCode": "\nconst items = $input.all();\nconst today = new Date().toISOString().slice(0, 10);\nconst records = items.filter(i => i.json.Date <= today);\n\nconst getAvg = (arr, key) =>\n  arr.length ? arr.reduce((sum, r) => sum + parseFloat(r.json[key] || 0), 0) / arr.length : 0;\n\nconst todayData = records.filter(r => r.json.Date === today);\nconst past7Days = records.filter(r => {\n  const d = new Date(r.json.Date);\n  const ref = new Date();\n  ref.setDate(ref.getDate() - 7);\n  return d >= ref && d < new Date(today);\n});\n\nconst alerts = [];\n\ntodayData.forEach((row) => {\n  const campaign = row.json.Campaign_ID || 'Sin nombre';\n  const cacToday = parseFloat(row.json.CAC || 0);\n  const roasToday = parseFloat(row.json.ROAS || 0);\n  const cacAvg = getAvg(past7Days, 'CAC');\n  const roasAvg = getAvg(past7Days, 'ROAS');\n\n  if (cacAvg && cacToday > cacAvg * 1.25) {\n    alerts.push({\n      json: {\n        type: \"CAC alto\",\n        campaign,\n        valor: cacToday,\n        promedio: cacAvg,\n        diff: `${(((cacToday / cacAvg) - 1) * 100).toFixed(1)}%`,\n        date: today,\n        link: `https://lookerstudio.google.com/reporting/tu-dashboard-id/page/123?campaign=${campaign}`\n      }\n    });\n  }\n\n  if (roasAvg && roasToday < roasAvg * 0.75) {\n    alerts.push({\n      json: {\n        type: \"ROAS bajo\",\n        campaign,\n        valor: roasToday,\n        promedio: roasAvg,\n        diff: `${(((roasToday / roasAvg) - 1) * 100).toFixed(1)}%`,\n        date: today,\n        link: `https://lookerstudio.google.com/reporting/tu-dashboard-id/page/123?campaign=${campaign}`\n      }\n    });\n  }\n});\n\nreturn alerts;\n"}, "name": "Detectar Anomal\u00edas", "type": "n8n-nodes-base.function", "typeVersion": 1, "position": [500, 300]}, {"parameters": {"values": {"string": [{"name": "message", "value": "\ud83d\udea8 Alerta KPI ({{$json.type}}) - Campa\u00f1a: {{$json.campaign}}\nValor actual: {{$json.valor}}\nPromedio: {{$json.promedio}}\nDesviaci\u00f3n: {{$json.diff}}\n\ud83d\udd17 Ver campa\u00f1a: {{$json.link}}"}]}}, "name": "Formatear Mensaje", "type": "n8n-nodes-base.set", "typeVersion": 1, "position": [700, 300]}, {"parameters": {"resource": "message", "operation": "send", "text": "={{$json.message}}", "channel": "@marketing_alerts"}, "name": "Enviar a Telegram", "type": "n8n-nodes-base.telegram", "typeVersion": 1, "position": [900, 300]}], "connections": {"Trigger cada 3h": {"main": [["Read SSOT"]]}, "Read SSOT": {"main": [["Detectar Anomal\u00edas"]]}, "Detectar Anomal\u00edas": {"main": [["Formatear Mensaje"]]}, "Formatear Mensaje": {"main": [["Enviar a Telegram"]]}}}